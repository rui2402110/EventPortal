<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント入力フォーム with カレンダー</title>
    <style>
    /* 既存のスタイル + カレンダー用スタイル */
.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    font-family: Arial, sans-serif;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.form-actions {
    text-align: center;
    margin-top: 30px;
}

.form-actions button {
    margin: 0 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.form-actions button[type="submit"] {
    background-color: #007bff;
    color: white;
}

.form-actions button[type="button"] {
    background-color: #6c757d;
    color: white;
}

.loading {
    text-align: center;
    padding: 20px;
    font-size: 18px;
}

.result-section {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.result-section table {
    width: 100%;
    border-collapse: collapse;
}

.result-section td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
}

.error {
    color: red;
    background-color: #ffe6e6;
    padding: 10px;
    border-radius: 4px;
}

/* カレンダー用スタイル */
.calendar-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.calendar-input {
    cursor: pointer;
    background-color: #f8f9fa;
}

.calendar-popup {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 16px;
    width: 320px;
    display: none;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.calendar-nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.calendar-nav-btn:hover {
    background-color: #f0f0f0;
}

.calendar-title {
    font-size: 16px;
    font-weight: bold;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 8px;
}

.calendar-weekday {
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    color: #666;
    padding: 8px 4px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 16px;
}

.calendar-day {
    width: 36px;
    height: 36px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.calendar-day:hover {
    background-color: #e3f2fd;
}

.calendar-day.other-month {
    color: #ccc;
}

.calendar-day.selected {
    background-color: #2196f3;
    color: white;
}

.calendar-day.today {
    background-color: #e1f5fe;
    color: #0277bd;
    font-weight: bold;
}

.time-selectors {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
}

.time-selector {
    flex: 1;
}

.time-selector label {
    display: block;
    margin-bottom: 4px;
    font-size: 12px;
    font-weight: bold;
}

.time-selector select {
    width: 100%;
    padding: 4px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.selected-datetime {
    background-color: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 16px;
    font-size: 14px;
}

.calendar-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.calendar-btn {
    padding: 6px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.calendar-btn.primary {
    background-color: #2196f3;
    color: white;
    border-color: #2196f3;
}

.calendar-btn:hover {
    background-color: #f0f0f0;
}

.calendar-btn.primary:hover {
    background-color: #1976d2;
}

/* 郵便番号予測のスタイル */
.postal-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover,
.suggestion-item.selected {
    background-color: #f0f0f0;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.form-group small {
    color: #666;
    font-size: 12px;
}
    </style>
</head>
<div class="container">
    <h1>イベント入力フォーム</h1>

    <div id="loadingMessage" class="loading">
        フォームを初期化しています...
    </div>

    <form id="addressForm" style="display: none;">
        <div class="form-group">
            <label for="event_name">イベント名</label>
            <input type="text" id="event_name" name="event_name" placeholder="例: ドキドキマヤ文明鎮魂祭" required>
        </div>

        <div class="form-group">
            <label for="days">日時</label>
            <div class="calendar-container">
                <input type="text" id="days" name="days" class="calendar-input" placeholder="日時を選択してください" readonly
                    required>
                <div id="calendar-popup" class="calendar-popup">
                    <div class="calendar-header">
                        <button type="button" class="calendar-nav-btn" id="prev-month">‹</button>
                        <div class="calendar-title" id="calendar-title"></div>
                        <button type="button" class="calendar-nav-btn" id="next-month">›</button>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">日</div>
                        <div class="calendar-weekday">月</div>
                        <div class="calendar-weekday">火</div>
                        <div class="calendar-weekday">水</div>
                        <div class="calendar-weekday">木</div>
                        <div class="calendar-weekday">金</div>
                        <div class="calendar-weekday">土</div>
                    </div>

                    <div class="calendar-days" id="calendar-days"></div>

                    <div class="time-selectors">
                        <div class="time-selector">
                            <label>時</label>
                            <select id="hour-select"></select>
                        </div>
                        <div class="time-selector">
                            <label>分</label>
                            <select id="minute-select"></select>
                        </div>
                    </div>

                    <div class="selected-datetime">
                        <strong>選択中:</strong> <span id="selected-display">未選択</span>
                    </div>

                    <div class="calendar-buttons">
                        <button type="button" class="calendar-btn" id="calendar-cancel">キャンセル</button>
                        <button type="button" class="calendar-btn primary" id="calendar-confirm">決定</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="content">概要</label>
            <input type="text" id="content" name="content" placeholder="例: マヤ文明の魂を鎮魂します" required>
        </div>

        <div class="form-group">
            <label for="postalCode">郵便番号</label>
            <input type="text" id="postalCode" name="postalCode" placeholder="例: 123-4567" maxlength="8" required>
            <small>ハイフンを含めて入力してください</small>
        </div>

        <div class="form-group">
            <label for="prefecture">都道府県</label>
            <select id="prefecture" name="prefecture" required>
                <option value="">選択してください</option>
                <option value="北海道">北海道</option>
                <option value="青森県">青森県</option>
                <option value="岩手県">岩手県</option>
                <option value="宮城県">宮城県</option>
                <option value="秋田県">秋田県</option>
                <option value="山形県">山形県</option>
                <option value="福島県">福島県</option>
                <option value="茨城県">茨城県</option>
                <option value="栃木県">栃木県</option>
                <option value="群馬県">群馬県</option>
                <option value="埼玉県">埼玉県</option>
                <option value="千葉県">千葉県</option>
                <option value="東京都">東京都</option>
                <option value="神奈川県">神奈川県</option>
                <option value="新潟県">新潟県</option>
                <option value="富山県">富山県</option>
                <option value="石川県">石川県</option>
                <option value="福井県">福井県</option>
                <option value="山梨県">山梨県</option>
                <option value="長野県">長野県</option>
                <option value="岐阜県">岐阜県</option>
                <option value="静岡県">静岡県</option>
                <option value="愛知県">愛知県</option>
                <option value="三重県">三重県</option>
                <option value="滋賀県">滋賀県</option>
                <option value="京都府">京都府</option>
                <option value="大阪府">大阪府</option>
                <option value="兵庫県">兵庫県</option>
                <option value="奈良県">奈良県</option>
                <option value="和歌山県">和歌山県</option>
                <option value="鳥取県">鳥取県</option>
                <option value="島根県">島根県</option>
                <option value="岡山県">岡山県</option>
                <option value="広島県">広島県</option>
                <option value="山口県">山口県</option>
                <option value="徳島県">徳島県</option>
                <option value="香川県">香川県</option>
                <option value="愛媛県">愛媛県</option>
                <option value="高知県">高知県</option>
                <option value="福岡県">福岡県</option>
                <option value="佐賀県">佐賀県</option>
                <option value="長崎県">長崎県</option>
                <option value="熊本県">熊本県</option>
                <option value="大分県">大分県</option>
                <option value="宮崎県">宮崎県</option>
                <option value="鹿児島県">鹿児島県</option>
                <option value="沖縄県">沖縄県</option>
            </select>
        </div>

        <div class="form-group">
            <label for="city">市区町村</label>
            <input type="text" id="city" name="city" placeholder="例: 渋谷区" required>
        </div>

        <div class="form-group">
            <label for="street">町名・番地</label>
            <input type="text" id="street" name="street" placeholder="例: 神南1-19-11" required>
        </div>

        <div class="form-group">
            <label for="building">建物名・部屋番号</label>
            <input type="text" id="building" name="building" placeholder="例: パークウェルビル5F（任意）">
            <small>マンション名や部屋番号がある場合は入力してください</small>
        </div>

      <div class="form-group">
        <label>会場マップ画像</label>
        <input type="file" id="eventMapImage" accept="image/*" onchange="previewImage(event, 'mapPreview')">
        <div class="preview" id="mapPreview"></div>
      </div>

      <div class="form-group">
        <label>会場内マップ画像</label>
        <input type="file" id="eventInnerMapImage" accept="image/*" onchange="previewImage(event, 'innerMapPreview')">
        <div class="preview" id="innerMapPreview"></div>
      </div>

      <div class="form-group">
            <label for="maxcount">最大人数</label>
            <input type="text" id="maxcount" name="maxcount" placeholder="例:　500">
        </div>

        <div class="form-group">
            <label for="category">カテゴリ</label>
            <input type="text" id="category" name="category" placeholder="カンマは,ですよ">
            <small>カンマ区切りで入力してください</small>
        </div>

        <div class="form-group">
            <label for="phonenumber">電話番号</label>
            <input type="text" id="phonenumber" name="phonenumber" placeholder="例:　0120-500-500">
        </div>

        <div class="form-group">
            <label for="link">リンク</label>
            <input type="text" id="link" name="link" placeholder="例:　https://job-hunting.o-hara.ac.jp/Account?ReturnUrl=%2fActivityMember%2fSearch_Company%2f0%2f1">
        </div>

        <div class="form-group">
            <label for="credit">クレジット(任意)</label>
            <input type="text" id="credit" name="credit" placeholder="例:　引間実業">
        </div>

        <div class="form-actions">
            <button type="button" id="clearBtn">クリア</button>
            <button type="submit">確認</button>
        </div>
    </form>

    <div id="result" class="result-section" style="display: none;">
        <h2>入力内容確認</h2>
        <div id="resultContent"></div>
        <div class="form-actions">
            <button type="button" id="editBtn">編集</button>
            <button type="button" id="submitBtn">送信</button>
        </div>
    </div>
</div>
<script>
function previewImage(event, previewId) {
    const file = event.target.files[0];
    const preview = document.getElementById(previewId);
    preview.innerHTML = ""; // 初期化

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  }
//グローバル変数
let currentCalendarDate = new Date();
let selectedDateTime = new Date();
let isCalendarOpen = false;

// DOM要素
const form = document.getElementById('addressForm');
const resultDiv = document.getElementById('result');
const resultContent = document.getElementById('resultContent');
const clearBtn = document.getElementById('clearBtn');
const editBtn = document.getElementById('editBtn');
const submitBtn = document.getElementById('submitBtn');
const loadingMessage = document.getElementById('loadingMessage');
const postalCodeInput = document.getElementById('postalCode');

// カレンダー要素
const calendarInput = document.getElementById('days');
const calendarPopup = document.getElementById('calendar-popup');
const calendarTitle = document.getElementById('calendar-title');
const calendarDays = document.getElementById('calendar-days');
const hourSelect = document.getElementById('hour-select');
const minuteSelect = document.getElementById('minute-select');
const selectedDisplay = document.getElementById('selected-display');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
const calendarCancelBtn = document.getElementById('calendar-cancel');
const calendarConfirmBtn = document.getElementById('calendar-confirm');

// 郵便番号検索用の変数
let postalData = [];
let isDataLoaded = false;
let suggestionDiv = null;
let currentSuggestions = [];
let selectedIndex = -1;

// カレンダー初期化
function initializeCalendar() {
    // 時間の選択肢を生成
    hourSelect.innerHTML = '';
    for (let i = 0; i < 24; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i.toString().padStart(2, '0') + '時';
        hourSelect.appendChild(option);
    }

    // 分の選択肢を生成（5分刻み）
    minuteSelect.innerHTML = '';
    for (let i = 0; i < 60; i += 5) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i.toString().padStart(2, '0') + '分';
        minuteSelect.appendChild(option);
    }

    // デフォルト時間を現在時刻に設定
    const now = new Date();
    selectedDateTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), Math.floor(now.getMinutes() / 5) * 5);
    currentCalendarDate = new Date(selectedDateTime);

    hourSelect.value = selectedDateTime.getHours();
    minuteSelect.value = selectedDateTime.getMinutes();

    updateCalendarDisplay();
    updateSelectedDisplay();
}

// カレンダー表示更新
function updateCalendarDisplay() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();

    calendarTitle.textContent = `${year}年 ${month + 1}月`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();

    calendarDays.innerHTML = '';

    // 前月の日付
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayElement = createDayElement(day, true, false, false);
        calendarDays.appendChild(dayElement);
    }

    // 今月の日付
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day);
        const isSelected = (selectedDateTime.getFullYear() === year && selectedDateTime.getMonth() === month && selectedDateTime.getDate() === day);
        const dayElement = createDayElement(day, false, isToday, isSelected);
        calendarDays.appendChild(dayElement);
    }

    // 次月の日付（42セル埋めるため）
    const totalCells = 42;
    const currentCells = firstDay + daysInMonth;
    for (let day = 1; currentCells + day - 1 < totalCells; day++) {
        const dayElement = createDayElement(day, true, false, false);
        calendarDays.appendChild(dayElement);
    }
}

// 日付要素作成
function createDayElement(day, isOtherMonth, isToday, isSelected) {
    const dayElement = document.createElement('button');
    dayElement.type = 'button';
    dayElement.className = 'calendar-day';
    dayElement.textContent = day;

    if (isOtherMonth) {
        dayElement.classList.add('other-month');
    }
    if (isToday) {
        dayElement.classList.add('today');
    }
    if (isSelected) {
        dayElement.classList.add('selected');
    }

    dayElement.addEventListener('click', () => {
        if (isOtherMonth) {
            // 前月・次月の日付をクリックした場合は月を移動
            if (day > 15) {
                // 前月
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            } else {
                // 次月
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            }
        }

        // 選択日を更新
        selectedDateTime.setFullYear(currentCalendarDate.getFullYear());
        selectedDateTime.setMonth(currentCalendarDate.getMonth());
        selectedDateTime.setDate(day);

        updateCalendarDisplay();
        updateSelectedDisplay();
    });

    return dayElement;
}

// 選択中の日時表示更新
function updateSelectedDisplay() {
    const year = selectedDateTime.getFullYear();
    const month = selectedDateTime.getMonth() + 1;
    const date = selectedDateTime.getDate();
    const hour = selectedDateTime.getHours();
    const minute = selectedDateTime.getMinutes();
    const weekday = ['日', '月', '火', '水', '木', '金', '土'][selectedDateTime.getDay()];

    selectedDisplay.textContent = `${year}年${month}月${date}日(${weekday}) ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
}

// カレンダーポップアップの表示/非表示
function toggleCalendar() {
    if (isCalendarOpen) {
        calendarPopup.style.display = 'none';
        isCalendarOpen = false;
    } else {
        // カレンダーを開く前に現在の入力値を確認
        const currentValue = calendarInput.value;
        if (currentValue) {
            // 既に入力されている値がある場合は、その値をカレンダーに反映
            const dateTimeMatch = currentValue.match(/(\d{4})年(\d{1,2})月(\d{1,2})日.*?(\d{1,2}):(\d{2})/);
            if (dateTimeMatch) {
                const [, year, month, date, hour, minute] = dateTimeMatch;
                selectedDateTime = new Date(
                    parseInt(year),
                    parseInt(month) - 1,
                    parseInt(date),
                    parseInt(hour),
                    parseInt(minute)
                );
                currentCalendarDate = new Date(selectedDateTime);

                // セレクトボックスの値も更新
                hourSelect.value = selectedDateTime.getHours();
                minuteSelect.value = selectedDateTime.getMinutes();

                updateCalendarDisplay();
                updateSelectedDisplay();
            }
        }

        calendarPopup.style.display = 'block';
        isCalendarOpen = true;
    }
}

// フォーム送信処理
form.addEventListener('submit', function(e) {
    e.preventDefault();

    // バリデーション
    if (!validateForm()) {
        return;
    }

    // 入力内容を確認画面に表示
    showConfirmation();
});

// バリデーション関数
function validateForm() {
    const postalCode = document.getElementById('postalCode').value;
    const postalCodePattern = /^\d{3}-\d{4}$/;

    if (!postalCodePattern.test(postalCode)) {
        alert('郵便番号は123-4567の形式で入力してください');
        return false;
    }

    return true;
}

// 確認画面表示
function showConfirmation() {
    const formData = new FormData(form);
    let html = '<table>';

    html += `<tr><td>イベント名:</td><td>${formData.get('event_name')}</td></tr>`;
    html += `<tr><td>日時:</td><td>${formData.get('days')}</td></tr>`;
    html += `<tr><td>概要:</td><td>${formData.get('content')}</td></tr>`;
    html += `<tr><td>郵便番号:</td><td>${formData.get('postalCode')}</td></tr>`;
    html += `<tr><td>都道府県:</td><td>${formData.get('prefecture')}</td></tr>`;
    html += `<tr><td>市区町村:</td><td>${formData.get('city')}</td></tr>`;
    html += `<tr><td>町名・番地:</td><td>${formData.get('street')}</td></tr>`;

    if (formData.get('building')) {
        html += `<tr><td>建物名・部屋番号:</td><td>${formData.get('building')}</td></tr>`;
    }

    html += '</table>';

    resultContent.innerHTML = html;
    form.style.display = 'none';
    resultDiv.style.display = 'block';
}

// CSVファイルを読み込む
async function loadCSVData() {
    try {
        // Shift_JISエンコーディングでCSVファイルを読み込む
        const response = await fetch('/EventPortal/eventportal/host/csv/x-ken-all.csv');
        const arrayBuffer = await response.arrayBuffer();

        // TextDecoderでShift_JISをデコード
        const decoder = new TextDecoder('shift_jis');
        const csvText = decoder.decode(arrayBuffer);

        const lines = csvText.split('\n');

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // CSVの各行をパースする（カンマ区切り、ダブルクォートを考慮）
            const cols = parseCSVLine(line);
            if (cols.length >= 9) {
                postalData.push({
                    zipcode: cols[2], // 郵便番号
                    prefecture: cols[6], // 都道府県名
                    city: cols[7], // 市区町村名
                    town: cols[8] // 町域名
                });
            }
        }

        isDataLoaded = true;
        console.log(`郵便番号データを${postalData.length}件読み込みました`);

    } catch (error) {
        console.error('CSVファイルの読み込みに失敗しました:', error);
        // CSVファイルが読み込めない場合はAPIを使用
        isDataLoaded = false;
    }
}

// CSV行をパースする関数（ダブルクォートとカンマを考慮）
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                // エスケープされたダブルクォート
                current += '"';
                i++; // 次の文字をスキップ
            } else {
                // クォートの開始/終了
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            // フィールドの区切り
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }

    result.push(current); // 最後のフィールドを追加
    return result;
}

// 郵便番号検索（CSVデータから）
function searchPostalCodeFromCSV(inputCode) {
    if (!isDataLoaded) return [];

    const results = postalData.filter(item => {
        return item.zipcode.startsWith(inputCode);
    });

    // 重複を除去（同じ郵便番号の場合）
    const uniqueResults = results.reduce((acc, current) => {
        const existing = acc.find(item => item.zipcode === current.zipcode);
        if (!existing) {
            acc.push(current);
        }
        return acc;
    }, []);

    // 郵便番号順でソート
    uniqueResults.sort((a, b) => a.zipcode.localeCompare(b.zipcode));

    // 最大8件に制限
    return uniqueResults.slice(0, 8);
}

// 郵便番号検索API（zipcloudを使用、CSVが使えない場合のフォールバック）
async function searchPostalCodeFromAPI(postalCode) {
    // ハイフンを除去
    const cleanCode = postalCode.replace('-', '');

    if (cleanCode.length !== 7) {
        return null;
    }

    try {
        const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanCode}`);
        const data = await response.json();

        if (data.status === 200 && data.results && data.results.length > 0) {
            // API結果をCSVデータと同じ形式に変換
            const result = data.results[0];
            return {
                zipcode: cleanCode,
                prefecture: result.address1,
                city: result.address2,
                town: result.address3
            };
        }
        return null;
    } catch (error) {
        console.error('郵便番号検索エラー:', error);
        return null;
    }
}

// 郵便番号入力時の処理
async function handlePostalCodeInput() {
    const inputValue = postalCodeInput.value;
    const cleanCode = inputValue.replace('-', '');

    // 3桁以上入力された場合に検索を実行
    if (cleanCode.length >= 3) {
        let results = [];

        if (isDataLoaded) {
            // CSVデータから検索
            results = searchPostalCodeFromCSV(cleanCode);
        } else {
            // 7桁完全入力の場合のみAPIで検索
            if (cleanCode.length === 7) {
                const apiResult = await searchPostalCodeFromAPI(inputValue);
                if (apiResult) {
                    results = [apiResult];
                }
            }
        }

        if (results.length > 0) {
            showSuggestions(results);
        } else {
            hideSuggestions();
        }
    } else {
        hideSuggestions();
    }
}

// 予測候補を表示
function showSuggestions(results) {
    hideSuggestions();

    currentSuggestions = results;
    selectedIndex = -1;

    suggestionDiv = document.createElement('div');
    suggestionDiv.className = 'postal-suggestions';

    results.forEach((result, index) => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';

        const formattedZipcode = result.zipcode.substring(0, 3) + '-' + result.zipcode.substring(3);
        suggestionItem.innerHTML = `
            <div style="font-weight: bold;">〒${formattedZipcode}</div>
            <div>${result.prefecture}${result.city}${result.town}</div>
        `;

        suggestionItem.addEventListener('click', () => selectSuggestion(result));
        suggestionItem.addEventListener('mouseenter', () => {
            selectedIndex = index;
            updateSuggestionSelection();
        });

        suggestionDiv.appendChild(suggestionItem);
    });

    // 郵便番号入力欄の親要素に相対位置を設定
    const inputGroup = postalCodeInput.closest('.form-group');
    inputGroup.style.position = 'relative';
    inputGroup.appendChild(suggestionDiv);
}

// 候補選択状態の更新
function updateSuggestionSelection() {
    if (!suggestionDiv) return;

    const items = suggestionDiv.querySelectorAll('.suggestion-item');
    items.forEach((item, index) => {
        if (index === selectedIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// 候補を選択
function selectSuggestion(result) {
    // 郵便番号を設定
    const formattedZipcode = result.zipcode.substring(0, 3) + '-' + result.zipcode.substring(3);
    postalCodeInput.value = formattedZipcode;

    // 都道府県を設定
    const prefectureSelect = document.getElementById('prefecture');
    prefectureSelect.value = result.prefecture;

    // 市区町村を設定
    const cityInput = document.getElementById('city');
    cityInput.value = result.city;

    // 町名を設定（既存の入力がない場合のみ）
    const streetInput = document.getElementById('street');
    if (!streetInput.value && result.town) {
        streetInput.value = result.town;
    }

    hideSuggestions();

    // 次のフィールドにフォーカス
    streetInput.focus();
}

// 候補を非表示
function hideSuggestions() {
    if (suggestionDiv) {
        suggestionDiv.remove();
        suggestionDiv = null;
    }
    currentSuggestions = [];
    selectedIndex = -1;
}

// イベントリスナー設定
function setupEventListeners() {
    // カレンダー関連
    calendarInput.addEventListener('click', toggleCalendar);

    prevMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        updateCalendarDisplay();
    });

    nextMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        updateCalendarDisplay();
    });

    hourSelect.addEventListener('change', (e) => {
        selectedDateTime.setHours(parseInt(e.target.value));
        updateSelectedDisplay();
    });

    minuteSelect.addEventListener('change', (e) => {
        selectedDateTime.setMinutes(parseInt(e.target.value));
        updateSelectedDisplay();
    });

    calendarCancelBtn.addEventListener('click', () => {
        toggleCalendar();
    });

    calendarConfirmBtn.addEventListener('click', () => {
        const year = selectedDateTime.getFullYear();
        const month = selectedDateTime.getMonth() + 1;
        const date = selectedDateTime.getDate();
        const hour = selectedDateTime.getHours();
        const minute = selectedDateTime.getMinutes();
        const weekday = ['日', '月', '火', '水', '木', '金', '土'][selectedDateTime.getDay()];

        calendarInput.value = `${year}年${month}月${date}日(${weekday}) ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        toggleCalendar();
    });

    // カレンダー外をクリックで閉じる
    document.addEventListener('click', (e) => {
        if (!calendarInput.contains(e.target) && !calendarPopup.contains(e.target)) {
            if (isCalendarOpen) {
                calendarPopup.style.display = 'none';
                isCalendarOpen = false;
            }
        }
    });

    // 郵便番号関連のイベントリスナー
    postalCodeInput.addEventListener('input', function(e) {
        // 郵便番号フォーマット処理
        let value = e.target.value.replace(/[^0-9]/g, '');
        // -を追加する処理
        if (value.length >= 3) {
            value = value.slice(0, 3) + '-' + value.slice(3, 7);
        }
        e.target.value = value;

        // 郵便番号検索処理
        handlePostalCodeInput();
    });

    // 郵便番号入力欄でのキーボード操作
    postalCodeInput.addEventListener('keydown', function(e) {
        if (currentSuggestions.length === 0) return;

        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                updateSuggestionSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSuggestionSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0) {
                    selectSuggestion(currentSuggestions[selectedIndex]);
                }
                break;
            case 'Escape':
                hideSuggestions();
                break;
        }
    });

    // 郵便番号入力欄のフォーカス喪失時
    postalCodeInput.addEventListener('blur', function() {
        // 少し遅延して候補を非表示にする（クリックイベントを処理するため）
        setTimeout(hideSuggestions, 200);
    });

    // ボタンイベント
    clearBtn.addEventListener('click', function() {
        form.reset();
        // カレンダーを初期化
        initializeCalendar();
        calendarInput.value = '';
        hideSuggestions();
    });

    editBtn.addEventListener('click', function() {
        form.style.display = 'block';
        resultDiv.style.display = 'none';
    });

 // ========================================
 // FrontController + Actionパターン用の実装
 // ========================================


 // 送信ボタンのイベントリスナー
 submitBtn.addEventListener('click', function() {
     // バリデーション
     if (!confirm('この内容で登録しますか？')) {
         return;
     }

     // ローディング表示
     loadingMessage.textContent = '送信中...';
     loadingMessage.style.display = 'block';
     submitBtn.disabled = true;
     editBtn.disabled = true;

     try {

     	 // フォームデータを送信
    	 const formData = new FormData();
         formData.append('event_name', document.getElementById('event_name').value);
         formData.append('days', document.getElementById('days').value);
         formData.append('content', document.getElementById('content').value);
         formData.append('postalCode', document.getElementById('postalCode').value);
         formData.append('prefecture', document.getElementById('prefecture').value);
         formData.append('city', document.getElementById('city').value);
         formData.append('street', document.getElementById('street').value);
         formData.append('building', document.getElementById('building').value || '');

         // 画像ファイル
         const mapImageFile = document.getElementById('eventMapImage').files[0];
         if (mapImageFile) {
             formData.append('eventMapImage', mapImageFile);
         }

         const innerMapImageFile = document.getElementById('eventInnerMapImage').files[0];
         if (innerMapImageFile) {
             formData.append('eventInnerMapImage', innerMapImageFile);
         }

         // その他の情報
         formData.append('maxcount', document.getElementById('maxcount').value);
         formData.append('category', document.getElementById('category').value);
         formData.append('phonenumber', document.getElementById('phonenumber').value);
         formData.append('link', document.getElementById('link').value);
         formData.append('credit', document.getElementById('credit').value || '');


         // Actionクラスにデータを送信
         const response = fetch('/EventPortal/eventportal/hostmenu/HostEventCreate.action', {
             method: 'POST',
             body: formData
         });

         // レスポンスの確認
         if (!response.ok) {
             throw new Error(`HTTPエラー: ${response.status}`);
         }

     } catch (error) {

     }
 });
}

// 初期化処理
function initialize() {
    loadingMessage.textContent = 'フォームを初期化しています...';

    // 少し遅延してからフォームを表示（ローディング効果）
    setTimeout(async () => {
        initializeCalendar();
        setupEventListeners();

        // 郵便番号データの読み込みを開始
        await loadCSVData();

        loadingMessage.style.display = 'none';
        form.style.display = 'block';
    }, 500);
}

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>

</html>